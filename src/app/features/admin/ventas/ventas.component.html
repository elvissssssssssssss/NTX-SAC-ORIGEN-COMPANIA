<!-- ventas.component.html -->

  <div class="container-fluid">
    <h2>Historial de Ventas</h2>
    
    <!-- Indicador de carga -->
    <div *ngIf="cargando" class="text-center my-4">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
      <p>Cargando ventas...</p>
    </div>
    
    <table class="table table-bordered table-striped" *ngIf="!cargando">
      <thead class="table-dark">
        <tr>
          <th>ID</th>
          <th>Usuario</th>
          <th>Método de Pago</th>
          <th>Total</th>
          <th>Fecha</th>
          <th>Detalles</th>
          <th>Envío</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let venta of ventas">
          <td>{{ venta.id }}</td>
          
          <!-- ✅ Mostrar nombre y email del usuario -->
          <td>
            <div class="user-info">
              <div class="d-flex align-items-center">
                <div class="avatar-circle bg-primary me-2">
                  {{ getInitialsFromName(venta.usuarioNombre || '') }}
                </div>
                <div>
                  <strong class="d-block">{{ venta.usuarioNombre || 'Usuario desconocido' }}</strong>
                  <a [href]="'mailto:' + venta.usuarioEmail" class="text-primary small">
                    <i class="fas fa-envelope me-1"></i>{{ venta.usuarioEmail }}
                  </a>
                  <small class="text-muted d-block">ID: {{ venta.userId }}</small>
                
<small
  class="badge"
  [ngClass]="{
    'bg-warning':
      venta.metodoPagoId === 1 && (venta.estadoVoucher || 'pendiente') === 'pendiente',
    'bg-success':
      venta.metodoPagoId === 1 && venta.estadoVoucher === 'aprobado' ||
      venta.metodoPagoId !== 1,
    'bg-danger':
      venta.metodoPagoId === 1 && venta.estadoVoucher === 'rechazado'
  }">
  {{
    venta.metodoPagoId === 1
      ? (venta.estadoVoucher || 'pendiente')
      : 'pagado'
  }}
</small>



                </div>
              </div>
            </div>
          </td>
          
          <td>
            {{ venta.metodoPagoNombre }}
            <small class="text-muted d-block">ID: {{ venta.metodoPagoId }}</small>
          </td>
          <td>{{ venta.total | currency:'PEN' }}</td>
          <td>{{ venta.fechaVenta | date:'short' }}</td>
          <td>
            <div *ngIf="venta.detalles && venta.detalles.length > 0; else noDetalles">
              <ul class="mb-0">
                <li *ngFor="let det of venta.detalles">
                  <strong>{{ det.nombreProducto }}</strong><br />
                  Cant: {{ det.cantidad }} | S/. {{ det.precio }}
                </li>
              </ul>
            </div>
            <ng-template #noDetalles>
              <em>Sin detalles</em>
            </ng-template>
          </td>
          <td>
            <div *ngIf="venta.envio; else sinEnvio">
              <i class="fas fa-shipping-fast text-success"></i>
              <small class="d-block">{{ venta.envio.provincia }}, {{ venta.envio.region }}</small>
            </div>
            <ng-template #sinEnvio>
              <span class="badge bg-warning">Sin envío</span>
            </ng-template>
          </td>
          <td>
            <button 
              class="btn btn-sm btn-primary" 
              (click)="verDetalleCompleto(venta)"
              title="Ver más detalles">
              <i class="fas fa-eye"></i> Ver
            </button>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Sección de detalle completo -->
    <div *ngIf="ventaSeleccionada" class="card mt-4 shadow">
      <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h4 class="mb-0">Detalles de Venta #{{ ventaSeleccionada.id }}</h4>
        <button class="btn btn-sm btn-light" (click)="cerrarDetalle()">
          <i class="fas fa-times"></i> Cerrar
        </button>
      </div>
      <div class="card-body">
        <div class="row">
          <!-- Columna izquierda: Info general -->
          <div class="col-md-6">
            <h5><i class="fas fa-info-circle"></i> Información General</h5>
            <hr>
            
            <!-- ✅ Información del usuario mejorada -->
            <div class="user-detail mb-3">
              <div class="d-flex align-items-center mb-2">
                <div class="avatar-circle bg-primary me-2">
                  {{ getInitialsFromName(ventaSeleccionada.usuarioNombre || '') }}
                </div>
                <div>
                  <strong class="d-block">{{ ventaSeleccionada.usuarioNombre }}</strong>
                  <a [href]="'mailto:' + ventaSeleccionada.usuarioEmail" class="text-primary">
                    <i class="fas fa-envelope me-1"></i>{{ ventaSeleccionada.usuarioEmail }}
                  </a>
                </div>
              </div>
            </div>
            
            <p><strong>Método de Pago:</strong> {{ ventaSeleccionada.metodoPagoNombre }}</p>
          <p>
  <strong>Estado pago:</strong>
  <span
    class="badge"
    [ngClass]="{
      'bg-warning':
        ventaSeleccionada.metodoPagoId === 1 &&
        (ventaSeleccionada.estadoVoucher || 'pendiente') === 'pendiente',
      'bg-success':
        ventaSeleccionada.metodoPagoId === 1 &&
        ventaSeleccionada.estadoVoucher === 'aprobado' ||
        ventaSeleccionada.metodoPagoId !== 1,
      'bg-danger':
        ventaSeleccionada.metodoPagoId === 1 &&
        ventaSeleccionada.estadoVoucher === 'rechazado'
    }"
  >
    {{
      ventaSeleccionada.metodoPagoId === 1
        ? (ventaSeleccionada.estadoVoucher || 'pendiente')
        : 'pagado'
    }}
  </span>
</p>



            <p><strong>Total:</strong> {{ ventaSeleccionada.total | currency:'PEN' }}</p>
            <p><strong>Fecha:</strong> {{ ventaSeleccionada.fechaVenta | date:'dd/MM/yyyy HH:mm' }}</p>
            
            <!-- Sección de envío -->
            <div *ngIf="ventaSeleccionada.envio" class="mt-4">
              <h5><i class="fas fa-map-marker-alt"></i> Información de Envío</h5>
              <hr>
              <div class="alert alert-info">
                <p class="mb-2"><strong>Dirección:</strong> {{ ventaSeleccionada.envio.direccion }}</p>
                <p class="mb-2"><strong>Región:</strong> {{ ventaSeleccionada.envio.region }}</p>
                <p class="mb-2"><strong>Provincia:</strong> {{ ventaSeleccionada.envio.provincia }}</p>
                <p class="mb-2"><strong>Localidad:</strong> {{ ventaSeleccionada.envio.localidad }}</p>
                <p class="mb-2"><strong>DNI:</strong> {{ ventaSeleccionada.envio.dni }}</p>
                <p class="mb-0"><strong>Teléfono:</strong> {{ ventaSeleccionada.envio.telefono }}</p>
              </div>
            </div>
            <div *ngIf="!ventaSeleccionada.envio" class="mt-4">
              <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i> No hay información de envío registrada
              </div>
            </div>
          </div>
          
          <!-- Columna derecha: Productos -->
          <div class="col-md-6">
            <h5><i class="fas fa-shopping-cart"></i> Productos</h5>
            <hr>
            <div class="table-responsive">
              <table class="table table-sm table-hover">
                <thead class="table-light">
                  <tr>
                    <th>Producto</th>
                    <th>Cantidad</th>
                    <th>Precio Unit.</th>
                    <th>Subtotal</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let det of ventaSeleccionada.detalles">
                    <td>{{ det.nombreProducto }}</td>
                    <td>{{ det.cantidad }}</td>
                    <td>S/. {{ det.precio | number:'1.2-2' }}</td>
                    <td>S/. {{ (det.cantidad * det.precio) | number:'1.2-2' }}</td>
                  </tr>
                </tbody>
                <tfoot class="table-success">
                  <tr>
                    <td colspan="3" class="text-end"><strong>Total:</strong></td>
                    <td><strong>{{ ventaSeleccionada.total | currency:'PEN' }}</strong></td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>


          
          <div class="mt-3" *ngIf="ventaSeleccionada.voucherArchivo">
  <h5><i class="fas fa-receipt"></i> Voucher de pago</h5>
  <hr>
  <img
    [src]="'https://pusher-backend-elvis.onrender.com/uploads/vouchers/' + ventaSeleccionada.voucherArchivo"
    alt="Voucher"
    class="img-fluid rounded border"
    style="max-height: 300px; object-fit: contain;">
</div>





<div class="mt-4 text-center">
  <button class="btn btn-success me-2" (click)="imprimirVenta(ventaSeleccionada)">
    <i class="fas fa-print"></i> Imprimir
  </button>
  <button class="btn btn-info me-2" (click)="exportarVenta(ventaSeleccionada)">
    <i class="fas fa-download"></i> Exportar CSV
  </button>

<button
  *ngIf="
    ventaSeleccionada.metodoPagoId === 1 &&
    (ventaSeleccionada.estadoVoucher || 'pendiente') === 'pendiente'
  "
  class="btn btn-primary me-2"
  (click)="verificarVoucher(ventaSeleccionada)"
>
  <i class="fas fa-check-circle"></i> Marcar como verificado
</button>

<button
  *ngIf="
    ventaSeleccionada.metodoPagoId === 1 &&
    (ventaSeleccionada.estadoVoucher || 'pendiente') === 'pendiente'
  "
  class="btn btn-danger ms-2"
  (click)="rechazarVoucher(ventaSeleccionada)"
>
  <i class="fas fa-times-circle"></i> Rechazar voucher
</button>


</div>

        </div>
        

      </div>
    </div>
  </div>
